name: Check for repro
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  check-repro:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const user = context.payload.sender.login;
            const body = context.payload.comment
              ? context.payload.comment.body
              : context.payload.issue.body;

            const URL_REGEXP = /### Website or app\n\n([^#]+)###/m;
            const REPRO_STEPS_REGEXP = /### Repro steps\n\n([^#]+)###/m;

            const urlMatch = body.match(URL_REGEXP);
            const reproStepsMatch = body.match(REPRO_STEPS_REGEXP);

            const url = urlMatch !== null ? urlMatch[1].trim() : null;
            const reproSteps = reproStepsMatch !== null ? reproStepsMatch[1].trim() : null;

            const COMMENT_HEADER = `
                          @${user}: We're sorry you've seen this error.

                          Unfortunately, it doesn't look like this issue has enough info for one of us to reproduce and fix it though.
                        `;

            const COMMENT_FOOTER = `
                          Please help us by providing a link to a CodeSandbox (https://codesandbox.io/s/new), a repository on GitHub, or a minimal code example that reproduces the problem. (Screenshots or videos can also be helpful if they help provide context on how to repro the bug.)

                          Here are some tips for providing a minimal example: https://stackoverflow.com/help/mcve
                        `;

            let commentToAdd = null;

            if (url && url.includes("/localhost")) {
              commentToAdd = `
                            ${COMMENT_HEADER}

                            The URL "localhost" is not publicly accessible.

                            ${COMMENT_FOOTER}
                          `;
            } else if (url && url.includes(" website")) {
              commentToAdd = `
                            ${COMMENT_HEADER}

                            It looks like you've provided an invalid URL.

                            ${COMMENT_FOOTER}
                          `;
            } else if (reproSteps && reproSteps.length < 25) {
              commentToAdd = `
                            ${COMMENT_HEADER}

                            ${COMMENT_FOOTER}
                          `;
            }

            if (commentToAdd !== null) {
              const comments = await github.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              if (comments.data.some(comment => comment.body.includes('Please help us by providing a link to a CodeSandbox'))) {
                return;
              }

              await github.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: commentToAdd
                  .split("\n")
                  .map((line) => line.trim())
                  .join("\n")
                  .trim(),
              });

              await github.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ["Resolution: Needs More Information"],
              });
            }
